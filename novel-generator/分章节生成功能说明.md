# 小说分章节生成功能说明

## 功能概述

为了解决小说生成超时的问题，我们实现了分章节生成功能。现在小说将分为8个章节逐步生成，每个章节单独生成以避免超时，并且使用前情提要来保持故事连贯性。

## 主要改进

### 1. 数据库结构优化

- **新增 `chapters` 表**: 管理小说章节，包含章节内容、状态、总结等
- **扩展 `novels` 表**: 添加总章节数和已完成章节数字段
- **改进 `dialogues` 表**: 建立与章节的关联关系

### 2. 分步生成流程

#### 第一步：生成大纲
- 用户上传材料后，首先生成小说大纲
- 大纲包含8个章节的基本框架
- API端点：`POST /api/novels/generate-outline`

#### 第二步：逐章生成
- 用户可以选择生成特定章节
- 使用前一章的总结作为前情提要
- API端点：`POST /api/novels/generate-chapter`

### 3. 前情提要机制

```python
def generate_chapter(self, category, novel_outline, chapter_number, previous_summary):
    """
    生成指定章节
    - category: 小说类别信息
    - novel_outline: 整体小说大纲
    - chapter_number: 当前章节号
    - previous_summary: 前一章总结（用作前情提要）
    """
```

每章生成时会：
1. 自动包含前一章的总结作为前情提要
2. 确保故事连贯性
3. 重点关注角色对白
4. 生成本章总结供下一章使用

### 4. 前端界面改进

#### 小说列表页面
- 显示小说进度（已完成章节/总章节数）
- 区分"查看详情"和"开始体验"按钮
- 支持新的小说状态：大纲已生成、章节生成中等

#### 小说详情页面（新增）
- 查看小说大纲和主角设定
- 章节列表显示每章状态
- 支持逐章生成和阅读

#### 章节阅读页面（新增）
- 独立的章节内容展示
- 对白详情和必需汉字标注
- 章节间导航

## API接口变更

### 新增接口

1. **生成大纲**
   ```
   POST /api/novels/generate-outline
   Body: { "category_id": 1 }
   ```

2. **生成章节**
   ```
   POST /api/novels/generate-chapter  
   Body: { "novel_id": 1, "chapter_number": 1 }
   ```

3. **获取章节详情**
   ```
   GET /api/novels/{novel_id}/chapters/{chapter_number}
   ```

### 修改接口

1. **获取小说列表** - 新增进度字段
2. **获取小说详情** - 包含章节列表

## 使用流程

### 用户操作流程

1. **上传材料** → 解析小说类别
2. **生成大纲** → 创建8章框架  
3. **逐章生成** → 按需生成具体章节内容
4. **阅读体验** → 查看章节或进入角色扮演

### 技术优势

- **避免超时**: 每次只生成一章，大大降低超时风险
- **灵活控制**: 用户可选择性生成感兴趣的章节
- **故事连贯**: 前情提要确保章节间逻辑连贯
- **对白重点**: 每章强调角色对白，符合项目需求

## 配置说明

### 章节设置
- 默认总章节数：8章
- 每章建议长度：1000-1500字
- 每章最少对白：15段

### 生成策略
- 第1章：可直接生成
- 第2-8章：需前一章完成后才能生成
- 超时处理：单章生成失败可重试

## 数据库迁移

运行以下命令更新数据库结构：

```bash
cd novel-generator/backend
python create_tables.py
```

## 前端路由

新增路由：
- `/novels/:novelId` - 小说详情页
- `/novels/:novelId/chapters/:chapterNumber` - 章节阅读页
- `/roleplay/:novelId/:chapterNumber` - 特定章节角色扮演

## 注意事项

1. **向后兼容**: 保持原有API的基本功能
2. **状态管理**: 章节生成状态的正确维护
3. **错误处理**: 生成失败时的状态回滚
4. **用户体验**: 清晰的进度显示和操作引导

这个分章节生成方案有效解决了原来小说一次性生成可能超时的问题，同时保持了故事的连贯性和对白的丰富性。
